@model Framework.ViewModels.HomeViewModel

<div class="waiting_loader" style="display: none"></div>

<div class="header-spacer"></div>


<div class="container">
    <div class="row">

        <!-- Main Content -->

        <main class="col-xl-6 push-xl-3 col-lg-12 push-lg-0 col-md-12 col-sm-12 col-xs-12">
            <div id="newsfeed-items-grid">

                @if (Model.Roles.Count == 0)
                {
                    <div class="ui-block">
                        <div class="news-feed-form">
                            <!-- Tab panes -->
                            <div class="tab-content">
                                <div class="tab-pane active" id="home-1" role="tabpanel" aria-expanded="true">
                                    <form id="question-form">
                                        <div class="author-thumb @Model.User.Degree">
                                            <img src="content/images/@Model.User.Avatar" alt="author">
                                        </div>
                                        <div class="form-group with-icon label-floating is-empty">
                                            <label class="control-label">Bạn đang thắc mắc về...</label>
                                            <textarea class="form-control" placeholder="" name="Content"></textarea>
                                            <div class="selection">
                                                <p>Hỏi tất cả mọi người</p>
                                                <div class="togglebutton" data-toggle="tooltip" data-placement="top" title="Bật để hỏi Thầy cô nha!">
                                                    <label>
                                                        <input type="checkbox">
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="add-options-message row ask-teacher">
                                            <label class="control-label">Vui lòng chọn loại câu hỏi</label>
                                            <fieldset class="form-group">
                                                <select class="selectpicker form-control" size="auto" name="Id_Type">
                                                    @foreach (var item in @Model.ListPostType)
                                                    {
                                                        <option value="@item.Id">@item.Name</option>
                                                    }
                                                </select>
                                            </fieldset>
                                        </div>
                                        <input type="hidden" name="DatePost" />
                                        <input type="hidden" name="Id_User" value="@Model.User.Id" />
                                        <input type="hidden" name="Option" value="0" />

                                        <div class="status-footer">
                                            <input type="submit" class="btn btn-primary btn-md-2" value="Đăng tải" />
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                @if (Model.ListPost == null)
                {
                    <div class="landing-main-content">
                        <h2 class="title">Rất tiếc, không tìm thấy</h2>
                        <p>Có vẻ như chưa có câu hỏi nào được đặt cho bạn</p>
                    </div>
                }
                <div id="partial">

                </div>

            </div>
            @if (Model.ListPost != null)
            {
                <a id="load-more-button" href="#" class="btn btn-control btn-more" data-load-link="items-to-load.html" data-container="newsfeed-items-grid"><svg class="olymp-three-dots-icon"><use xlink:href="content/icons/icons.svg#olymp-three-dots-icon"></use></svg></a>
            }
        </main>

        <!-- ... end Main Content -->
            @Html.Partial("_Notices")

            @Html.Partial("_Activities", Model)
        <!-- Window-popup Report -->

        <div class="modal fade" id="report">
            <div class="modal-dialog ui-block window-popup edit-widget edit-widget-twitter">
                <a href="#" class="close icon-close" data-dismiss="modal" aria-label="Close">
                    <svg class="olymp-close-icon"><use xlink:href="content/icons/icons.svg#olymp-close-icon"></use></svg>
                </a>

                <div class="ui-block-title">
                    <h6 class="title">Bài đăng này có nội dung xấu hay không phù hợp?</h6>
                </div>

                <div class="ui-block-content">
                    <fieldset class="form-group label-floating is-select">
                        <label class="control-label">Bài đăng này đã vi phạm vì</label>
                        <select class="selectpicker form-control" size="auto">
                            <option value="1">Nội dung xấu, kích động</option>
                            <option value="2">Chứa từ ngữ xấu, không phù hợp</option>
                        </select>
                    </fieldset>

                    <p>
                        Olympus cảm ơn bạn rất nhiều!
                    </p>
                    <p>
                        <b>Make Olympus great againt!</b>
                    </p>
                    <div class="modal-button">
                        <a href="#" class="btn btn-secondary btn-lg btn--half-width btn-icon-center" data-dismiss="modal" aria-label="Close">Thôi, tha</a>
                        <a href="#" class="btn btn-primary btn-lg btn--half-width btn-icon-center">Xóa dùm</a>
                    </div>
                </div>

            </div>
        </div>

        <!-- ... end Window-popup Report -->
        <!-- Window-popup Thank you -->
        <a data-toggle="modal" data-target="#thankyou" id="thankyou-button"></a>
        <div class="modal fade" id="thankyou">
            <div class="modal-dialog ui-block window-popup edit-widget edit-widget-twitter">
                <a href="#" class="close icon-close" data-dismiss="modal" aria-label="Close">
                    <svg class="olymp-close-icon"><use xlink:href="content/icons/icons.svg#olymp-close-icon"></use></svg>
                </a>

                <div class="ui-block-title">
                    <h6 class="title">Đã đăng bài thành công</h6>
                </div>

                <div class="ui-block-content">
                    <p>
                        Hệ thống đang tìm kiếm chuyên gia, vui lòng đợi trong giây lát...
                    </p>
                    <div class="modal-button">
                        <a href="#" class="btn btn-primary btn-lg btn-icon-center" data-dismiss="modal" aria-label="Close">OK</a>
                    </div>
                </div>

            </div>
        </div>

        <!-- ... end Window-popup Thank you -->
    </div>
</div>

<script>
    $(document).on("click", "#submit.options-message.active", function () {
        var parent = $(this).parent().parent().parent();
        var comment_section = parent.parent().find(".comments-list");
        var textarea = $(this).parent().parent().find("textarea#comment");
        var total = parent.parent().parent().find(".comments-shared span:last-child");
        var comment = textarea.val();
        var button = $(this);
        var form = $(this).closest("form");
        var total_comment = parseInt(total.text());
        total_comment++;
        $(form).find("input[name='Comment']").val(total_comment);
        $(form).find("input[name='DateComment']").val(Date.now);
        var new_comment;
        if (comment.length != 0) {
            $(".waiting_loader").css("display", "block");
            if (!$(this).hasClass("child-comment")) {
                var data = form.serialize();
                $.post("/Post/Comment", data).done(function (html) {
                    $(comment_section).append(html);
                    textarea.val("");
                    button.removeClass("active");
                    new_comment = $(comment_section).find("li.new-comment");
                    $(comment_section).find("li.new-comment").show('slow').addClass("showed");
                }).fail(function (response) {
                    $("#notify .ui-block-content p").html("Thành thật xin lỗi. <br/>Hình như có lỗi gì đó rồi, thử lại sau nhé!!!");
                    $("#notify-button").click();
                    total_comment--;
                }).always(function () {
                    $(".waiting_loader").css("display", "none");
                });
            }
            else {
                var index = $(this).attr("class").match(/(?:\s|^)child-comment-(\d+)/)[1];
                var parentcomment_section = $(comment_section).find("li.parent")[index];
                var childcomment_section = $(parentcomment_section).find("ul.children");
                var parentcomment_section_id = $(parentcomment_section).attr("id");
                $(form).find("input[name='Id_Comment']").val(parentcomment_section_id.substr(parentcomment_section_id.lastIndexOf("-") + 1));
                var data = form.serialize();
                $.post("/Post/Comment", data).done(function (html) {
                    $(childcomment_section).append(html);
                    textarea.val("");
                    new_comment = $(comment_section).find("li.new-comment");
                    button.removeClass("active").removeClass(function (index, className) {
                        return (className.match(/(^|\s)child-comment-\S+/g) || []).join(' ');
                    }).removeClass("child-comment");
                    $(childcomment_section).find("li.new-comment").show('slow').addClass("showed");
                    $(form).find("input[name='Id_Comment']").val("");
                    scrollto(parentcomment_section);
                }).fail(function (response) {
                    $("#notify .ui-block-content p").html("Thành thật xin lỗi. <br/>Hình như có lỗi gì đó rồi, thử lại sau nhé!!!");
                    $("#notify-button").click();
                    total_comment--;
                }).always(function () {
                    $(".waiting_loader").css("display", "none");
                });
            }
            total.text(total_comment);
        }
    });

    $(".comments-list li.parent:nth-child(1)").removeClass("not-showed").addClass("showed");
    $(".comments-list li.parent:nth-child(2)").removeClass("not-showed").addClass("showed");

    $(document).on("click", ".post-add-icon.upvote", function () {
        var button = $(this);
        var id_post = $(button).closest(".ui-block").attr("id");
        var id_comment = 0;
        var vote, upvote, downvote;
        if (button.parent().attr("id") != null) {
            id_comment = button.parent().attr("id").substr($(button).parent().attr("id").lastIndexOf("-") + 1)
        }
        if ($(button).hasClass("clicked")) {
            vote = 0;
            upvote = -1;
        }
        else {
            if ($(button).next().hasClass("clicked")) {
                downvote = -1;
            }
            upvote = 1;
            vote = 1;
        }
        var data = { Id_User: '@Model.User.Id', Id_Post: id_post, Id_Comment: id_comment, Vote: vote, UpVote: upvote, DownVote: downvote };
        var upvote = $(button).find("span");
        var number_upvote = parseInt(upvote.text());
        var downvote = $(button).next().find("span");
        var number_downvote = parseInt(downvote.text());
        if ($(button).hasClass("clicked")) {
            $(button).removeClass("clicked");
            number_upvote--;
            $(button).removeClass("active");
        }
        else {
            if ($(button).next().hasClass("clicked")) {
                $(button).next().removeClass("clicked");
                number_downvote--;
                $(button).next().removeClass("active");
            }
            $(button).addClass("clicked");
            number_upvote++;
            $(button).addClass("active");
            $(button).next().removeClass("active");
        }

        if (number_upvote < 0) {
            number_upvote = 0;
        }
        if (number_downvote < 0) {
            number_downvote = 0;
        }
        upvote.text(number_upvote);
        downvote.text(number_downvote);
        scrollto(button.parent());

        $.post("/Post/VotePost", data).done(function (response) {
            if (response.result != "success") {
                $("#notify .ui-block-content p").html("Thành thật xin lỗi. <br/>Hình như có lỗi gì đó rồi, thử lại sau nhé!!!");
                $("#notify-button").click();
            }
        }).fail(function (response) {
            $("#notify .ui-block-content p").html("Thành thật xin lỗi. <br/>Hình như có lỗi gì đó rồi, thử lại sau nhé!!!");
            $("#notify-button").click();
        })
    })

    $(document).on("click", ".post-add-icon.downvote", function () {
        var button = $(this);
        var id_post = $(button).closest(".ui-block").attr("id");
        var id_comment = 0;
        var vote, upvote, downvote;
        if (button.parent().attr("id") != null) {
            id_comment = button.parent().attr("id").substr($(button).parent().attr("id").lastIndexOf("-") + 1)
        }
        if ($(button).hasClass("clicked")) {
            vote = 0;
            downvote = -1;
        }
        else {
            if ($(button).prev().hasClass("clicked")) {
                upvote = -1;
            }
            vote = -1;
            downvote = 1;
        }
        var data = { Id_User: '@Model.User.Id', Id_Post: id_post, Id_Comment: id_comment, Vote: vote, UpVote: upvote, DownVote: downvote };
        var downvote = $(button).find("span");
        var number_downvote = parseInt(downvote.text());
        var upvote = $(button).prev().find("span");
        var number_upvote = parseInt(upvote.text());

        if ($(button).hasClass("clicked")) {
            $(button).removeClass("clicked");
            number_downvote--;
            $(button).removeClass("active");
        }
        else {
            if ($(button).prev().hasClass("clicked")) {
                $(button).prev().removeClass("clicked");
                number_upvote--;
                $(button).prev().removeClass("active");
            }
            $(button).addClass("clicked");
            number_downvote++;
            $(button).addClass("active");
            $(button).prev().removeClass("active");
        }

        if (number_upvote < 0) {
            number_upvote = 0;
        }
        if (number_downvote < 0) {
            number_downvote = 0;
        }
        upvote.text(number_upvote);
        downvote.text(number_downvote);
        scrollto(button.parent());
        $.post("/Post/VotePost", data).done(function (response) {
            if (response.result != "success") {
                $("#notify .ui-block-content p").html("Thành thật xin lỗi. <br/>Hình như có lỗi gì đó rồi, thử lại sau nhé!!!");
                $("#notify-button").click();
            }
        }).fail(function (response) {
            $("#notify .ui-block-content p").html("Thành thật xin lỗi. <br/>Hình như có lỗi gì đó rồi, thử lại sau nhé!!!");
            $("#notify-button").click();
        })
    });
    $(document).on("click", ".mark-answer", function () {
        var button = $(this);
        var id_post = $(button).closest(".ui-block").attr("id");
        var id_comment = button.closest("li").attr("id").substr($(button).closest("li").attr("id").lastIndexOf("-") + 1)
        var data = { Id_User: '@Model.User.Id', Id_Post: id_post, Id_Comment: id_comment, Corrected: true };
        $(".mark-answer").closest("li").not(button).removeClass("answer");
        button.closest("li").addClass("answer");
        $.post("/Post/MarkAnswer", data).done(function (response) {
            if (response.result == "success") {
                if (button.closest("li").attr("id") != response.answer) {
                    $(".mark-answer").closest("li").removeClass("answer");
                    $("#" + response.answer).addClass("answer");
                }
            }
            else {
                $("#notify .ui-block-content p").html("Thành thật xin lỗi. <br/>Hình như có lỗi gì đó rồi, thử lại sau nhé!!!");
                $("#notify-button").click();
            }
        }).fail(function (response) {
            $("#notify .ui-block-content p").html("Thành thật xin lỗi. <br/>Hình như có lỗi gì đó rồi, thử lại sau nhé!!!");
            $("#notify-button").click();
        })
    })
</script>

@if (ViewBag.newMember == "new")
{
    <!-- Window-popup Thank you -->
    <a data-toggle="modal" data-target="#type" id="type-button"></a>
    <div class="modal fade" id="type">
        <div class="modal-dialog ui-block window-popup edit-widget edit-widget-twitter">
            <a href="#" class="close icon-close" data-dismiss="modal" aria-label="Close">
                <svg class="olymp-close-icon"><use xlink:href="content/icons/icons.svg#olymp-close-icon"></use></svg>
            </a>

            <div class="ui-block-title">
                <h6 class="title">Mời bạn chọn loại câu hỏi mà bạn hứng thú</h6>
            </div>

            <div class="ui-block-content">
                <div class="ui-block">
                    @foreach (var item in @Model.ListPostType)
                    {
                    <div class="available-widget">
                        <div class="checkbox">
                            <label>
                                <input name="Type" value="@item.Id" type="checkbox">
                                @item.Name
                            </label>
                        </div>
                    </div>
                    }

                </div>

                <div class="modal-button">
                    <a href="#" class="btn btn-primary btn-lg btn-icon-center" data-dismiss="modal" aria-label="Close">OK</a>
                </div>
            </div>

        </div>
    </div>
    <!-- ... end Window-popup Thank you -->
    <!-- ... end Window-popup Report -->
    <a data-toggle="modal" data-target="#thanks" id="thanks-button"></a>

    <div class="modal fade" id="thanks">
        <div class="modal-dialog ui-block window-popup edit-widget edit-widget-twitter">
            <a href="#" class="close icon-close" data-dismiss="modal" aria-label="Close">
                <svg class="olymp-close-icon"><use xlink:href="~/content/icons/icons.svg#olymp-close-icon"></use></svg>
            </a>

            <div class="ui-block-title">
                <h6 class="title">Cảm ơn bạn</h6>
            </div>

            <div class="ui-block-content">
                <p>
                    Cảm ơn bạn!
                </p>
                <p>
                    Olympus đã ghi nhớ!
                </p>
                <p>
                    <b>Chúc bạn học tốt nhá!!!</b>
                </p>
                <div class="modal-button">
                    <a href="/?" class="btn btn-primary btn-lg btn-icon-center">Trở lại với Olympus</a>
                </div>
            </div>

        </div>
    </div>
    <script>
        setTimeout(function () { $("#type-button").click(); }, 3000);
        var typeList = [];
        $(document).on("click", "#type .modal-button a", function () {
            $(".checkbox.clicked input[name='Type']").each(function () {
                typeList.push($(this).val());
            });
            var data = { UserID: '@Model.User.Id', TypeList: typeList }
            $.post('/Home/RegisterType', data).done(function (response) {
                if (response.result == "success") {
                    $("#thanks-button").click();
                }
                else {
                    $("#notify .ui-block-content p").html("Thành thật xin lỗi. <br/>Hình như có lỗi gì đó rồi, thử lại sau nhé!!!");
                    $("#notify-button").click();
                }
            }).fail(function (response) {
                $("#notify .ui-block-content p").html("Thành thật xin lỗi. <br/>Hình như có lỗi gì đó rồi, thử lại sau nhé!!!")
                $("#notify-button").click();
            })
        })

    </script>
}

